syntax = "proto3";

import "google/protobuf/timestamp.proto";

package electrician;

option go_package = "github.com/joeydtaylor/electrician/pkg/internal/relay";

message WrappedPayload {
  string id = 1;
  google.protobuf.Timestamp timestamp = 2;
  bytes payload = 3;
  MessageMetadata metadata = 4;
  ErrorInfo error_info = 5;
  uint64 seq = 6;
}

message ErrorInfo {
  int32 code = 1;
  string message = 2;
  repeated string details = 3;
}

message MessageMetadata {
  map<string, string> headers = 1;
  string content_type = 2;
  VersionInfo version = 3;
  PerformanceOptions performance = 4;
  string trace_id = 5;
  int32 priority = 6;
  SecurityOptions security = 7;
  AuthenticationOptions authentication = 8;
  AuthContext auth_context = 9;
}

message SecurityOptions {
  bool enabled = 1;
  EncryptionSuite suite = 2;
}

enum EncryptionSuite {
  ENCRYPTION_NONE = 0;
  ENCRYPTION_AES_GCM = 1;
}

message VersionInfo {
  int32 major = 1;
  int32 minor = 2;
}

message PerformanceOptions {
  bool use_compression = 1;
  CompressionAlgorithm compression_algorithm = 2;
  int32 compression_level = 3;
}

enum CompressionAlgorithm {
  COMPRESS_NONE = 0;
  COMPRESS_DEFLATE = 1;
  COMPRESS_SNAPPY = 2;
  COMPRESS_ZSTD = 3;
  COMPRESS_BROTLI = 4;
  COMPRESS_LZ4 = 5;
}

enum AuthMode {
  AUTH_MODE_UNSPECIFIED = 0;
  AUTH_NONE = 1;        
  AUTH_OAUTH2 = 2;      
  AUTH_MUTUAL_TLS = 3;  
}

message AuthenticationOptions {
  bool enabled = 1;          
  AuthMode mode = 2;         
  OAuth2Options oauth2 = 3;  
  MTLSOptions mtls = 4;      
}

message OAuth2Options {
  bool accept_jwt = 1;              
  bool accept_introspection = 2;    

  string issuer = 3;                
  string jwks_uri = 4;              
  repeated string required_audience = 5;
  repeated string required_scopes = 6;

  string introspection_url = 7;
  string introspection_auth_type = 8;   
  string introspection_client_id = 9;
  string introspection_client_secret = 10;
  string introspection_bearer_token = 11;

  bool forward_bearer_token = 12;       
  string forward_metadata_key = 13;     

  int32 jwks_cache_seconds = 14;         
  int32 introspection_cache_seconds = 15; 
}

message MTLSOptions {
  repeated string allowed_principals = 1; 
  string trust_domain = 2;                
}

message AuthContext {
  AuthMode mode = 1;
  bool authenticated = 2;
  string principal = 3;                 
  string subject = 4;                   
  string client_id = 5;                 
  repeated string scopes = 6;
  map<string, string> claims = 7;       
  google.protobuf.Timestamp expires_at = 8;
  string issuer = 9;
  repeated string audience = 10;
  string token_id = 11;                 
}

enum AckMode {
  ACK_MODE_UNSPECIFIED = 0;
  ACK_PER_MESSAGE = 1;
  ACK_BATCH = 2;
  ACK_NONE = 3;
}

message StreamOpen {
  string stream_id = 1;
  MessageMetadata defaults = 2;
  AckMode ack_mode = 3;
  uint32 ack_every_n = 4;     
  uint32 max_in_flight = 5;
  bool omit_payload_metadata = 6;
}

message StreamClose {
  string reason = 1;
}

message RelayEnvelope {
  oneof msg {
    StreamOpen open = 1;
    WrappedPayload payload = 2;
    StreamClose close = 3;
  }
}

service RelayService {
  rpc Receive(WrappedPayload) returns (StreamAcknowledgment);
  rpc StreamReceive(stream RelayEnvelope) returns (stream StreamAcknowledgment);
}

message StreamAcknowledgment {
  bool success = 1;
  string message = 2;
  map<string, string> metadata = 3;
  string stream_id = 4;
  string id = 5;      
  uint64 seq = 6;     
  int32 code = 7;
  bool retryable = 8;
  uint64 last_seq = 9;
  uint32 ok_count = 10;
  uint32 err_count = 11;
}
