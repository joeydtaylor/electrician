# âš™ï¸ `pkg/internal/`

Welcome to the **engine room** of Electrician.

Everything under `pkg/internal/` is **implementation**, not public API. Go enforces this with the `internal/` import rule:

- âœ… Any package **under** `pkg/` can import `pkg/internal/...`
- âŒ Packages **outside** `pkg/` (and downstream users of this module) cannot

In this repo, that means:

- `pkg/` is the **public surface area** (what other packages in this module are meant to import)
- `pkg/internal/` is **private implementation** for `pkg/`
- `pkg/builder` is the **public exporter/wrapper**, assembling internal components via options/builders

---

## ğŸ§  What belongs in `internal/`

- Pipeline primitives (concurrency, backpressure, lifecycle)
- Reliability components (circuit breakers, rate limiting, recovery)
- Telemetry hooks (loggers/sensors/meters)
- Adapters + relays for integration surfaces (HTTP, gRPC, Kafka, S3, codecs, etc.)
- Shared contracts (`types/`) and small utilities (`utils/`)

What does *not* belong here:

- Stable user-facing ergonomics â†’ `pkg/builder`
- Public API commitments â†’ outside `pkg/internal/`

---

## ğŸ“¦ Packages (high-level map)

| Package | Role |
|---|---|
| `adapter/` | Integration-facing adapters (external systems / protocols / auth) |
| `httpserver/` | Inbound HTTP/HTTPS listener + request handling |
| `circuitbreaker/` | Failure detection + trip/reset behavior |
| `codec/` | Serialization / compression / encoding helpers used by pipelines |
| `conduit/` | Multi-stage wiring (linking components / wires) |
| `forwardrelay/` | Outgoing gRPC relay (send streams/events) |
| `receivingrelay/` | Incoming gRPC relay (receive/ingest streams/events) |
| `relay/` | Protobuf / gRPC contract code (generated + helpers) |
| `generator/` | Autonomous sources (synthetic feeds, pollers, etc.) |
| `internallogger/` | Structured logging backend used across internal components |
| `meter/` | Performance + counters (throughput, errors, timing) |
| `plug/` | Pluggable input source abstraction (adapter-like) |
| `resister/` | Queue-based smoothing / deferred delivery (rate-limit queue) |
| `sensor/` | Telemetry hooks/callbacks for pipeline events |
| `surgeprotector/` | Rate limiting + overload behavior around submission |
| `types/` | **Source of truth**: shared interfaces/contracts across components |
| `utils/` | Small internal helpers (hashes, common glue) |
| `wire/` | Core pipeline primitive: concurrent ingest â†’ transform â†’ emit |

---

## ğŸ§± File layout conventions

Many internal packages follow a consistent â€œshapeâ€, but itâ€™s not enforced everywhere:

| Common file | Typical purpose |
|---|---|
| `package.go` | Primary type + constructor |
| `api.go` | Methods intended to be called by other Electrician packages |
| `internal.go` | Private implementation details |
| `options.go` | Functional options (`With*`) for configuration |
| `*_test.go` | Unit/integration tests |

Notes:

- Donâ€™t assume every package uses every file name but if they have need of those features they will follow this convention â€” follow the code.

---

## ğŸ§© Design contract (configuration-first)

Electrician is built around one operational rule:

âœ… Configure â†’ Start â†’ Run â†’ Stop/Restart

- Components are expected to be connected/configured **before** `Start()`.
- Mutating configuration while a pipeline is running is **not supported** and may race.

This is a performance and correctness choice: predictable concurrency semantics and lean hot paths.

---

## ğŸš„ Performance philosophy (what we actually mean)

Electricianâ€™s performance work is targeted at the **core pipeline path** (especially `wire`):

- âœ… Avoid **per-element allocations** in core pipeline mechanics under typical configs.
- âœ… Prefer **worker-local state** (transformer factories, `WithScratchBytes`) over shared pools.
- âœ… Keep telemetry **best-effort** so it doesnâ€™t backpressure the pipeline.
- âœ… Catch regressions with tests (e.g. alloc-budget tests in `wire_test.go`).

What we do *not* claim:

- âŒ â€œZero allocations everywhere.â€ Integrations, encoders, and user transforms can allocate.

---

## ğŸ§° External dependencies

Electrician is **stdlib-first** for the pipeline core, but the repo is not dependency-free because integrations need real libraries for real protocols/file formats.

Two practical truths:

- âœ… Most third-party deps are **integration surfaces** (Kafka, S3, Parquet, compression). If you donâ€™t import those packages, they wonâ€™t be linked into your final binary.
- âœ… The hot-path primitives aim for **no per-element allocations** â€” but that does not magically apply to everything you plug into them.

### âœ… Direct dependencies by purpose (high level)

| Area | Libraries | What theyâ€™re used for |
|---|---|---|
| ğŸ§¾ Logging | `go.uber.org/zap` | Structured logging backend |
| ğŸ“¡ RPC / Messaging | `google.golang.org/grpc`, `google.golang.org/protobuf` | gRPC relays + cross-service streaming contracts |
| â˜ï¸ AWS | `github.com/aws/aws-sdk-go-v2/*` | S3/STS and related AWS integrations |
| ğŸ§µ Kafka | `github.com/segmentio/kafka-go` | Kafka producers/consumers for adapters and pipelines |
| ğŸ—œï¸ Compression / Codecs | `github.com/klauspost/compress`, `github.com/golang/snappy`, `github.com/pierrec/lz4`, `github.com/andybalholm/brotli` | Optional compression paths (often via codecs/Parquet) |
| ğŸ§± Parquet | `github.com/parquet-go/parquet-go` | Parquet IO (columnar formats) |
| ğŸ“ˆ Numerics / DSP | `gonum.org/v1/gonum`, `github.com/mjibson/go-dsp` | Optional math/DSP utilities where needed |
| ğŸ–¥ï¸ Host metrics | `github.com/shirou/gopsutil` | System/host introspection for telemetry |
| ğŸŒ Network helpers | `golang.org/x/net` | Supplemental networking primitives |

We keep these dependencies because theyâ€™re **boring, maintained, and widely deployed**. They exist to support integrations â€” not to reinvent Kafka, Parquet, AWS, or gRPC.

---

## ğŸ”§ Extending internal packages

If youâ€™re adding capabilities:

1) Update interfaces/contracts in `pkg/internal/types` if you need new cross-component behavior  
2) Implement on the internal component  
3) Add a `WithX` option if itâ€™s configuration-time behavior  
4) Add tests (and alloc tests where itâ€™s a hot path)

---

## ğŸ“– Further Reading

- **[Root README](../../README.md)** â€“ Electricianâ€™s overall architecture and principles.
- **[Per-Package README]** â€“ Each internal sub-package (`wire`, `circuitbreaker`, `httpserver`, etc.) contains additional details.
- **[Examples Directory](../../example/)** â€“ Demonstrates these internal components in real-world use cases.

---

## ğŸ“ License

All internal packages fall under Electricianâ€™s [Apache 2.0 License](../../LICENSE).  
You are free to use, modify, and distribute them under these terms, but note that **they are not designed for direct external use**.
